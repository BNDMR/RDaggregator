---
title: "orphatools-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{orphatools-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=8, fig.height=8
)
```

```{r setup}
suppressWarnings(suppressPackageStartupMessages(library(orphatools)))
suppressWarnings(suppressPackageStartupMessages(library(kableExtra)))
suppressWarnings(suppressPackageStartupMessages(library(dplyr)))
```


# Orpha code properties
**Classification Levels** :

  * Group of disorders : 36540
  * Disorder : 36547
  * Subtype of disorder : 36554

```{r props1}
code = '303' # Dystrophic epidermolysis bullosa
props = get_code_properties(code)
kable(props, 'html')

props = get_code_properties(code, literal_values = TRUE)
kable(props, 'html')
```
It is however recommended to load the nomenclature data first to avoid memory overflow when `get_code_properties` is called multiple times.

```{r props2}
nom_data = load_nomenclature()
props = get_code_properties(code, nom_data = nom_data)
kable(props, 'html')
```

# Find corresponding disorder / lowest groups of disorders
```{r rolling_up}
subtype_to_disorder(subtypeCode = 158676) # 158676 is a subtype of disorder
subtype_to_disorder(subtypeCode = 303) # 303 is a group of disorder
get_lowest_groups(orphaCode = 158676)
```


# Ancestors
## Find ancestors codes
```{r ancestors1}
ancestors_codes = get_ancestors(code, codes_only=TRUE)
print(ancestors_codes)
```

## Build edgelist
```{r ancestors2}
df_ancestors = get_ancestors(code)
kable(df_ancestors, 'html')
```
Depth was calculated for displaying purpose.

### Specify classification
**Classifications list :**
```{r class}
all_class = load_classifications()
print(names(all_class))
```


```{r ancestors3}
df_ancestors = get_ancestors(code, class_data = all_class[['ORPHAclassification_156_rare_genetic_diseases_fr']])
kable(df_ancestors, 'html')
df_ancestors = get_ancestors(code, class_data = all_class[['ORPHAclassification_146_rare_cardiac_diseases_fr']])
kable(df_ancestors, 'html')
```
/

# Descendants
## Find descendants codes
```{r descendants1}
descendants_codes = get_descendants(code, codes_only=TRUE)
print(descendants_codes)
```

## Build edgelist
```{r descendants2}
df_descendants = get_descendants(code)
kable(df_descendants, 'html')
```
Depth was calculated for displaying purpose.

### Specify classification
Specifying classification won't change the output but will just save a small amount of time.
```{r descendants3}
df_descendants = get_descendants(code, class_data = all_class[['ORPHAclassification_156_rare_genetic_diseases_fr']])
kable(df_descendants, 'html')
df_descendants = get_descendants(code, class_data = all_class[['ORPHAclassification_146_rare_cardiac_diseases_fr']])
kable(df_ancestors, 'html')
```
/

# Visualization
## Plots
```{r visu1}
df_ancestors = get_ancestors(code)
graph_ancestors = igraph::graph_from_data_frame(df_ancestors)

plot(graph_ancestors)
plot(graph_ancestors, layout=igraph::layout_as_tree)
plot(graph_ancestors, layout=layout_tree)
```
Try `interactive_plot` function for a dynamic plot.

## Hierarchical structures
```{r visu2}
df = get_descendants(307711)
graph = igraph::graph_from_data_frame(df)
plot(graph)

df_index = assign_indent_index(df)
df_test = df_index %>% mutate(N = 1:nrow(df_index))
M_shifted = apply_indent(df_test, cols_to_display = c('code', 'N'))
kable(M_shifted, 'html')
```


# Operations on multiple codes
## Common graph
The "common graph" merges the ancestors of each code in the list.
```{r common_graph}
codes_list = c('303', '305', '595356')
common_graph = get_common_graph(codes_list)
plot(common_graph, layout=layout_tree)
common_graph = color_graph(common_graph, emphasize_nodes = codes_list)
plot(common_graph, layout=layout_tree)
```

## Lowest Common Ancestors (LCAs)
```{r lcas}
get_LCAs(codes_list)
get_LCAs(codes_list, class_data = all_class[['ORPHAclassification_187_rare_skin_diseases_fr']])
```

## Find other relatives
This function is useful to find codes that might have been forgotten.

Setting *children_only* to TRUE will make the process much faster, but some "cousin codes" may be missed.

Setting *children_only* to FALSE will find every forgotten codes, but might last an eternity if an LCA is high in classification.
```{r relatives}
new_graph = get_relatives(codes_list) %>% 
  color_graph(emphasize_nodes = codes_list, display_class_levels = FALSE)
plot(new_graph, layout=layout_tree)

new_graph = get_relatives(codes_list, class_data = all_class[['ORPHAclassification_187_rare_skin_diseases_fr']]) %>% 
  color_graph(emphasize_nodes = codes_list, display_class_levels = FALSE)
plot(new_graph, layout=layout_tree)

new_graph = get_relatives(codes_list, children_only = TRUE) %>% 
  color_graph(emphasize_nodes = codes_list, display_class_levels = FALSE)
plot(new_graph, layout=layout_tree)
```

# Counting codes
```{r counting1}
df_patients = data.frame(patient_id = c(1,1,2,3,4,5,6),
                         code = c('303', '158673', '595356', '305', '79406', '79406', '595356'))
kable(df_patients, 'html')
```

## Naive counting method
```{r}
df_counts = df_patients %>% group_by(code) %>% count() %>% as.data.frame()
kable(df_counts, 'html')
```


## New counting method
#### Without deduplication
```{r counting2}
df_counts = df_patients %>% group_by_code() %>% count() %>% as.data.frame()
kable(df_counts, 'html')
```

#### With deduplication
```{r counting3}
df_counts = df_patients %>% group_by_code() %>% summarize(n = n_distinct(patient_id)) %>% as.data.frame()
kable(df_counts, 'html')
```

