---
title: "orphatools-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{orphatools-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(orphatools)
library(kableExtra)
library(dplyr)
```


# Orpha code properties
**Classification Levels** :

  * Group of disorders : 36540
  * Disorder : 36547
  * Subtype of disorder : 36554

```{r}
code = 303 # Dystrophic epidermolysis bullosa
props = get_code_properties(code)
kable(t(props), 'html')
```

# Find corresponding disorder / lowest groups of disorders
```{r}
subtype_to_disorder(subtypeCode = 158676)
subtype_to_disorder(subtypeCode = 303)
get_lowest_groups(orphaCode = 158676)
```


# Ancestors
## Find ancestors codes
```{r}
ancestors_codes = get_ancestors(code, codes_only=TRUE)
print(ancestors_codes)
```

## Build edgelist
```{r}
df_ancestors = get_ancestors(code)
kable(df_ancestors, 'html')
```
Depth was calculated for displaying purpose.

### Specify classification
**Classifications list :**
```{r}
all_class = load_classifications()
print(names(all_class))
```


```{r}
df_ancestors = get_ancestors(code, class_data = all_class[['ORPHAclassification_156_rare_genetic_diseases_fr']])
kable(df_ancestors, 'html')
df_ancestors = get_ancestors(code, class_data = all_class[['ORPHAclassification_146_rare_cardiac_diseases_fr']])
kable(df_ancestors, 'html')
```
/

# Descendants
## Find descendants codes
```{r}
descendants_codes = get_descendants(code, codes_only=TRUE)
print(descendants_codes)
```

## Build edgelist
```{r}
df_descendants = get_descendants(code)
kable(df_descendants, 'html')
```
Depth was calculated for displaying purpose.

### Specify classification
Specifying classification won't change the output but will just save a small amount of time.
```{r}
df_descendants = get_descendants(code, class_data = all_class[['ORPHAclassification_156_rare_genetic_diseases_fr']])
kable(df_descendants, 'html')
df_descendants = get_descendants(code, class_data = all_class[['ORPHAclassification_146_rare_cardiac_diseases_fr']])
kable(df_ancestors, 'html')
```
/

# Visualization
## Build igraph object
```{r}
df_ancestors = get_ancestors(code)
graph_ancestors = igraph::graph_from_data_frame(df_ancestors)
```

## Plot
```{r}
plot(graph_ancestors)
plot(graph_ancestors, layout=igraph::layout_as_tree)
plot(graph_ancestors, layout=layout_custom)
```

# Operations on multiple codes
## Common graph
The "common graph" merges the ancestors of each code in the list.
```{r}
codes_list = c(303, 305, 595356)
common_graph = get_common_graph(codes_list)
plot(common_graph, layout=layout_custom)
common_graph = get_common_graph(codes_list, colored=TRUE)
plot(common_graph, layout=layout_custom)
```

## Lowest Common Ancestors (LCAs)
```{r}
get_LCAs(codes_list)
get_LCAs(codes_list, class_data = all_class[['ORPHAclassification_187_rare_skin_diseases_fr']])
```

## Find other relatives
This function is useful to find codes that might have been forgotten.

Setting *children_only* to TRUE will make the process much faster, but some "cousin codes" may be missed.

Setting *children_only* to FALSE will find every forgotten codes, but might last an eternity if an LCA is high in classification.
```{r}
new_graph = get_relatives(codes_list)
plot(new_graph, layout=layout_custom)
new_graph = get_relatives(codes_list, class_data = all_class[['ORPHAclassification_187_rare_skin_diseases_fr']])
plot(new_graph, layout=layout_custom)
new_graph = get_relatives(codes_list, children_only = TRUE)
plot(new_graph, layout=layout_custom)
```

# Counting codes
```{r}
df_patients = data.frame(patient_id = c(1,1,2,3,4,5,6),
                         code = c(303, 158673, 595356, 305, 79406, 79406, 595356))
kable(df_patients, 'html')
```

## Naive counting method
```{r}
df_counts = df_patients %>% group_by(code) %>% count() %>% as.data.frame()
kable(df_counts, 'html')
```


## New counting method
#### Without deduplication
```{r}
df_counts = df_patients %>% group_by_code() %>% count() %>% as.data.frame()
kable(df_counts, 'html')
```

#### With deduplication
```{r}
df_counts = df_patients %>% group_by_code() %>% summarize(n = n_distinct(patient_id)) %>% as.data.frame()
kable(df_counts, 'html')
```

